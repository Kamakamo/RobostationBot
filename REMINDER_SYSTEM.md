# Система напоминаний для инженеров

## Описание

Система автоматических напоминаний предназначена для того, чтобы инженеры не забывали закрывать взятые в работу заявки. Напоминания отправляются каждые 30 минут, начиная с 30 минут после взятия заявки в работу, и продолжаются до тех пор, пока заявка не будет закрыта.

## Как это работает

### 1. Отслеживание времени взятия заявки

Когда инженер нажимает кнопку "Взять в работу":
- В `bot_data` сохраняется информация о времени взятия заявки
- Записывается ID инженера и ID заявки
- Устанавливается `last_reminder_time = None`

### 2. Периодическая проверка

Каждые 10 минут запускается задача `check_and_send_reminders()`, которая:
- Получает все заявки со статусом "В работе"
- Проверяет, есть ли данные отслеживания для каждой заявки
- Вычисляет время, прошедшее с момента взятия заявки или последнего напоминания
- Если прошло 30 минут с момента взятия заявки (для первого напоминания) или 30 минут с последнего напоминания (для повторных) - отправляет напоминание

### 3. Отправка напоминаний

Напоминания отправляются:
- **Первое**: через 30 минут после взятия заявки в работу
- **Последующие**: каждые 30 минут после предыдущего напоминания

Напоминание содержит:
- Номер заявки
- Название экспоната
- Описание проблемы
- Время, прошедшее с момента взятия заявки
- Напоминание о необходимости закрыть заявку

### 4. Очистка данных

При завершении заявки:
- Данные отслеживания автоматически удаляются из `bot_data`
- Освобождается память

## Файлы системы

### `reminders.py`
Основной модуль системы напоминаний со следующими функциями:

- `track_request_claim_time()` - начинает отслеживание заявки
- `cleanup_request_tracking()` - очищает данные при завершении заявки
- `check_and_send_reminders()` - проверяет и отправляет напоминания

### Изменения в `handlers/engineer.py`
- Добавлен импорт модуля `reminders`
- В функцию `claim_request()` добавлен вызов `track_request_claim_time()`
- В функции завершения заявки добавлен вызов `cleanup_request_tracking()`

### Изменения в `main.py`
- Добавлен импорт `check_and_send_reminders`
- Настроена периодическая задача с интервалом 10 минут

## Настройки

### Время напоминания
По умолчанию первое напоминание отправляется через 30 минут после взятия заявки в работу, а последующие - каждые 30 минут.
Это значение можно изменить в файле `reminders.py` в переменной `reminder_threshold`.

### Частота проверки
По умолчанию проверка выполняется каждые 10 минут.
Это значение можно изменить в файле `main.py` в параметре `interval` (указывается в секундах).

## Структура данных в bot_data

Для каждой заявки в работе создается ключ вида `claim_time_{request_id}` со значением:

```python
{
    "engineer_id": int,           # ID инженера в Telegram
    "claim_time": datetime,       # Время взятия заявки в работу
    "last_reminder_time": datetime or None  # Время последнего отправленного напоминания
}
```

## Логирование

Система ведет логи следующих событий:
- Начало отслеживания заявки
- Отправка напоминания инженеру
- Очистка данных отслеживания
- Ошибки при отправке напоминаний

Все логи записываются с уровнем INFO или ERROR в зависимости от типа события.