# Система напоминаний для инженеров

## Описание

Система автоматических напоминаний предназначена для того, чтобы инженеры не забывали закрывать взятые в работу заявки. Если инженер взял заявку в работу и не закрыл ее в течение 1 часа, ему автоматически отправляется напоминание в личные сообщения.

## Как это работает

### 1. Отслеживание времени взятия заявки

Когда инженер нажимает кнопку "Взять в работу":
- В `bot_data` сохраняется информация о времени взятия заявки
- Записывается ID инженера и ID заявки
- Устанавливается флаг `reminded = False`

### 2. Периодическая проверка

Каждые 10 минут запускается задача `check_and_send_reminders()`, которая:
- Получает все заявки со статусом "В работе"
- Проверяет, есть ли данные отслеживания для каждой заявки
- Вычисляет время, прошедшее с момента взятия заявки
- Если прошло больше 1 часа и напоминание еще не отправлялось - отправляет напоминание

### 3. Отправка напоминания

Напоминание содержит:
- Номер заявки
- Название экспоната
- Описание проблемы
- Напоминание о необходимости закрыть заявку

### 4. Очистка данных

При завершении заявки:
- Данные отслеживания автоматически удаляются из `bot_data`
- Освобождается память

## Файлы системы

### `reminders.py`
Основной модуль системы напоминаний со следующими функциями:

- `track_request_claim_time()` - начинает отслеживание заявки
- `cleanup_request_tracking()` - очищает данные при завершении заявки
- `check_and_send_reminders()` - проверяет и отправляет напоминания

### Изменения в `handlers/engineer.py`
- Добавлен импорт модуля `reminders`
- В функцию `claim_request()` добавлен вызов `track_request_claim_time()`
- В функции завершения заявки добавлен вызов `cleanup_request_tracking()`

### Изменения в `main.py`
- Добавлен импорт `check_and_send_reminders`
- Настроена периодическая задача с интервалом 10 минут

## Настройки

### Время напоминания
По умолчанию напоминание отправляется через 1 час после взятия заявки в работу.
Это значение можно изменить в файле `reminders.py` в переменной `reminder_threshold`.

### Частота проверки
По умолчанию проверка выполняется каждые 10 минут.
Это значение можно изменить в файле `main.py` в параметре `interval` (указывается в секундах).

## Структура данных в bot_data

Для каждой заявки в работе создается ключ вида `claim_time_{request_id}` со значением:

```python
{
    "engineer_id": int,      # ID инженера в Telegram
    "claim_time": datetime,  # Время взятия заявки в работу
    "reminded": bool         # Было ли отправлено напоминание
}
```

## Логирование

Система ведет логи следующих событий:
- Начало отслеживания заявки
- Отправка напоминания инженеру
- Очистка данных отслеживания
- Ошибки при отправке напоминаний

Все логи записываются с уровнем INFO или ERROR в зависимости от типа события.